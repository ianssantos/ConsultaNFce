<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta NFC-e SEFAZ PB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .card { background: white; padding: 25px; margin-bottom: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 150px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; font-family: monospace; }
        .btn { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #219955; }
        .btn-clear { background: #e74c3c; }
        .btn-clear:hover { background: #c0392b; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; background: #f9f9f9; }
        .success { border-left: 4px solid #27ae60; }
        .error { border-left: 4px solid #e74c3c; }
        .warning { border-left: 4px solid #f39c12; }
        .detail { margin: 5px 0; }
        .label { font-weight: bold; color: #555; }
        .summary { background: #2c3e50; color: white; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .manual-link { color: #3498db; text-decoration: none; }
        .manual-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Consulta NFC-e SEFAZ PB</h1>
            <p>Consulta em lote - Sem necessidade de instala√ß√£o</p>
        </header>
        
        <div class="card">
            <h2>Consultar NFC-e em Lote</h2>
            <p><strong>Instru√ß√µes:</strong> Cole as chaves NFC-e separadas por ponto e v√≠rgula (;) ou importe de arquivo TXT</p>
            
            <textarea id="chaves" placeholder="Exemplo: 24210607364602000133650010000012341000012345;24210607364602000133650010000012351000012346"></textarea>
            
            <div>
                <input type="file" id="fileInput" accept=".txt" style="margin: 10px 0;">
                <button class="btn" onclick="consultarNFCe()">Consultar NFC-e</button>
                <button class="btn btn-clear" onclick="limpar()">Limpar</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">
                <strong>‚ö†Ô∏è Importante:</strong> Devido a restri√ß√µes da SEFAZ, esta ferramenta agora gera links para consulta manual. Clique nos links gerados para verificar cada NFC-e.
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processando NFC-e's, aguarde...</p>
            <div id="progress"></div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Carregar arquivo TXT
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('chaves').value = e.target.result;
            };
            reader.readAsText(file);
        });

        function limpar() {
            document.getElementById('chaves').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('fileInput').value = '';
        }

        async function consultarNFCe() {
            const chaves = document.getElementById('chaves').value.trim();
            if (!chaves) {
                alert('Por favor, insira pelo menos uma chave NFC-e');
                return;
            }
            
            const chavesArray = chaves.split(';').map(chave => chave.trim()).filter(chave => chave);
            
            if (chavesArray.length === 0) {
                alert('Nenhuma chave v√°lida encontrada. Verifique o formato (separadas por ;)');
                return;
            }

            // Validar formato das chaves (44 d√≠gitos)
            const chavesInvalidas = chavesArray.filter(chave => !/^\d{44}$/.test(chave));
            if (chavesInvalidas.length > 0) {
                alert(`As seguintes chaves t√™m formato inv√°lido (devem ter 44 d√≠gitos):\n${chavesInvalidas.slice(0, 5).join('\n')}`);
                return;
            }

            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';

            try {
                await processarConsultas(chavesArray);
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao processar NFC-e. Verifique o console para detalhes.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function processarConsultas(chavesArray) {
            const resultsDiv = document.getElementById('results');
            let successCount = 0;
            let errorCount = 0;

            // Adicionar resumo inicial
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'summary';
            summaryDiv.innerHTML = `<h3>Processando ${chavesArray.length} NFC-e's</h3><p>Gerando links para consulta manual...</p>`;
            resultsDiv.appendChild(summaryDiv);

            for (let i = 0; i < chavesArray.length; i++) {
                const chave = chavesArray[i];
                
                // Atualizar progresso
                document.getElementById('progress').innerHTML = 
                    `Processando ${i + 1} de ${chavesArray.length}`;

                try {
                    // Gerar informa√ß√µes b√°sicas da chave
                    const resultado = gerarInfoChave(chave);
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item success';
                    
                    resultItem.innerHTML = `
                        <h3>NFC-e ${i + 1} - LINK GERADO</h3>
                        <div class="detail"><span class="label">Chave:</span> ${resultado.chave}</div>
                        <div class="detail"><span class="label">N√∫mero:</span> ${resultado.numero}</div>
                        <div class="detail"><span class="label">S√©rie:</span> ${resultado.serie}</div>
                        <div class="detail"><span class="label">CNPJ Emitente:</span> ${resultado.cnpj}</div>
                        <div class="detail"><span class="label">Data Emiss√£o:</span> ${resultado.dataEmissao}</div>
                        <div class="detail">
                            <span class="label">Consulta:</span> 
                            <a href="${resultado.url}" target="_blank" class="manual-link">üîó Consultar na SEFAZ PB</a>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: #e8f4fd; border-radius: 4px;">
                            <small>Clique no link acima para verificar o status na SEFAZ</small>
                        </div>
                    `;
                    
                    resultsDiv.appendChild(resultItem);
                    successCount++;

                } catch (error) {
                    errorCount++;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item error';
                    resultItem.innerHTML = `
                        <h3>NFC-e ${i + 1} - ERRO</h3>
                        <div class="detail"><span class="label">Chave:</span> ${chave}</div>
                        <div class="detail"><span class="label">Erro:</span> ${error.message}</div>
                    `;
                    resultsDiv.appendChild(resultItem);
                }

                // Pequena pausa para n√£o sobrecarregar a interface
                if (i < chavesArray.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            // Atualizar resumo final
            summaryDiv.innerHTML = `
                <h3>Processamento Conclu√≠do</h3>
                <div class="detail">Total processado: ${chavesArray.length} NFC-e's</div>
                <div class="detail" style="color: #27ae60">Links gerados: ${successCount}</div>
                <div class="detail" style="color: #e74c3c">Erros: ${errorCount}</div>
                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px;">
                    <strong>‚úì Pronto!</strong> Clique nos links acima para verificar cada NFC-e no site oficial da SEFAZ PB.
                </div>
            `;

            document.getElementById('progress').innerHTML = 
                `Processamento finalizado: ${successCount} links gerados, ${errorCount} erros`;
        }

        function gerarInfoChave(chave) {
            // Estrutura da chave NFC-e (44 d√≠gitos):
            // UF (2) + AAMM (4) + CNPJ (14) + modelo (2) + s√©rie (3) + n√∫mero (9) + tpEmis (1) + cNF (9)
            
            if (!/^\d{44}$/.test(chave)) {
                throw new Error('Chave inv√°lida - deve conter 44 d√≠gitos');
            }

            // Extrair informa√ß√µes da chave
            const uf = chave.substring(0, 2);
            const anoMes = chave.substring(2, 6);
            const cnpj = chave.substring(6, 20);
            const modelo = chave.substring(20, 22);
            const serie = chave.substring(22, 25);
            const numero = chave.substring(25, 34);
            
            // Formatar CNPJ
            const cnpjFormatado = `${cnpj.substring(0, 2)}.${cnpj.substring(2, 5)}.${cnpj.substring(5, 8)}/${cnpj.substring(8, 12)}-${cnpj.substring(12, 14)}`;
            
            // Extrair data da chave (AAMM)
            const ano = '20' + anoMes.substring(0, 2);
            const mes = anoMes.substring(2, 4);
            const dataEmissao = `${mes}/${ano}`;
            
            // Gerar URL de consulta
            const url = `https://www.sefaz.pb.gov.br/servirtual/documentos-fiscais/nfc-e/consultar-nfc-e?chave=${chave}`;
            
            return {
                chave: chave,
                numero: numero,
                serie: serie,
                cnpj: cnpjFormatado,
                dataEmissao: dataEmissao,
                url: url,
                status: 'LINK_GERADO'
            };
        }

        // Fun√ß√£o alternativa para tentar consulta autom√°tica (opcional)
        async function tentarConsultaAutomatica(chave) {
            try {
                // Tentar usar um servi√ßo de terceiros que possa acessar a SEFAZ
                const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://www.sefaz.pb.gov.br/servirtual/documentos-fiscais/nfc-e/consultar-nfc-e?chave=${chave}`)}`);
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // Verificar se a consulta foi bloqueada
                    if (html.includes('captcha') || html.includes('blocked') || html.length < 1000) {
                        throw new Error('Consulta bloqueada pela SEFAZ');
                    }
                    
                    return html;
                }
                
                throw new Error('Falha na requisi√ß√£o');
            } catch (error) {
                throw new Error('Consulta autom√°tica indispon√≠vel: ' + error.message);
            }
        }

        // Fun√ß√£o para copiar todas as chaves formatadas
        function copiarChavesFormatadas() {
            const chaves = document.getElementById('chaves').value.trim();
            if (!chaves) {
                alert('N√£o h√° chaves para copiar');
                return;
            }
            
            const chavesArray = chaves.split(';').map(chave => chave.trim()).filter(chave => chave);
            const chavesFormatadas = chavesArray.map(chave => {
                const info = gerarInfoChave(chave);
                return `${info.chave} | ${info.numero} | ${info.dataEmissao} | ${info.cnpj}`;
            }).join('\n');
            
            navigator.clipboard.writeText(chavesFormatadas).then(() => {
                alert('Chaves copiadas para a √°rea de transfer√™ncia!');
            });
        }
    </script>
</body>
</html>